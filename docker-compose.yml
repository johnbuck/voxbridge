services:
  # WhisperX STT Server - Handles speech-to-text with GPU
  whisperx:
    build:
      context: .
      dockerfile: Dockerfile.whisperx
    container_name: voxbridge-whisperx
    security_opt:
      - seccomp:unconfined
    ports:
      - "4901:4901"  # WebSocket
      - "4902:4902"  # Health check
    volumes:
      - ./src/whisper_server.py:/app/src/whisper_server.py  # Live code updates
      - ./requirements.txt:/app/requirements.txt             # For reference
      - whisperx-models:/root/.cache/whisperx                # Cache downloaded models
    environment:
      - WHISPERX_MODEL=${WHISPERX_MODEL:-small}
      - WHISPERX_DEVICE=${WHISPERX_DEVICE:-auto}
      - WHISPERX_COMPUTE_TYPE=${WHISPERX_COMPUTE_TYPE:-float16}
      - WHISPERX_BATCH_SIZE=${WHISPERX_BATCH_SIZE:-16}
      - WHISPER_SERVER_PORT=4901
    restart: unless-stopped
    networks:
      - bot-network
      - pinkleberry_bridge
    # GPU support - Use GPU 1 only
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['1']
              capabilities: [gpu]

  # VoxBridge Discord - Python Discord voice bridge (STT/TTS)
  voxbridge-discord:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: voxbridge-discord
    ports:
      - "4900:4900"
    volumes:
      - ./src/discord_bot.py:/app/src/discord_bot.py              # Live code updates
      - ./src/whisper_client.py:/app/src/whisper_client.py        # Live code updates
      - ./src/speaker_manager.py:/app/src/speaker_manager.py      # Live code updates
      - ./src/streaming_handler.py:/app/src/streaming_handler.py  # Live code updates
      - ./requirements-bot.txt:/app/requirements-bot.txt          # For reference
      - ./assets:/app/assets                                      # Thinking indicator sound effects
    environment:
      # Discord
      - DISCORD_TOKEN=${DISCORD_TOKEN}

      # WhisperX Configuration - Connect to whisperx container
      - WHISPER_SERVER_URL=ws://whisperx:4901

      # Speaker Management
      - SILENCE_THRESHOLD_MS=${SILENCE_THRESHOLD_MS:-600}
      - MAX_SPEAKING_TIME_MS=${MAX_SPEAKING_TIME_MS:-45000}

      # Chatterbox TTS
      - CHATTERBOX_URL=${CHATTERBOX_URL:-http://chatterbox:4800}
      - CHATTERBOX_VOICE_ID=${CHATTERBOX_VOICE_ID}

      # n8n Integration
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}
      - N8N_WEBHOOK_TEST_URL=${N8N_WEBHOOK_TEST_URL}
      - N8N_TEST_MODE=${N8N_TEST_MODE:-false}

      # Streaming Configuration
      - USE_STREAMING=${USE_STREAMING:-true}

      # Latency Optimization Features
      - USE_CLAUSE_SPLITTING=${USE_CLAUSE_SPLITTING:-true}
      - USE_PARALLEL_TTS=${USE_PARALLEL_TTS:-false}
      - USE_PROGRESSIVE_TTS_PLAYBACK=${USE_PROGRESSIVE_TTS_PLAYBACK:-false}
      - USE_THINKING_INDICATORS=${USE_THINKING_INDICATORS:-true}
      - THINKING_INDICATOR_PROBABILITY=${THINKING_INDICATOR_PROBABILITY:-0.8}
      - MIN_CLAUSE_LENGTH=${MIN_CLAUSE_LENGTH:-10}
      - MIN_SENTENCE_LENGTH=${MIN_SENTENCE_LENGTH:-3}
      - DISCORD_AUDIO_QUEUE_SIZE=${DISCORD_AUDIO_QUEUE_SIZE:-100}

      # Server Config
      - PORT=4900
    depends_on:
      - whisperx
    restart: unless-stopped
    networks:
      - bot-network
      - pinkleberry_bridge

  # VoxBridge Frontend - React monitoring dashboard
  voxbridge-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: voxbridge-frontend
    ports:
      - "${FRONTEND_PORT:-4901}:80"
    depends_on:
      - voxbridge-discord
    restart: unless-stopped
    networks:
      - bot-network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

networks:
  bot-network:
    external: true
  pinkleberry_bridge:
    external: true

volumes:
  whisperx-models:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ../zexternal-volumes/voxbridge-whisperx-models
